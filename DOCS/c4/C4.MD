# Diagrama C4 — Suvinil-IA

Este arquivo contém os blocos principais do Diagrama C4 do projeto Suvinil-IA em formato legível (para renderização com ferramentas de MD/PlantUML/Diagrama C4 simplificado).

## Contexto

Descrição rápida:

- Usuário: solicita recomendações de tintas.
- Suvinil-IA: motor de recomendação que combina RBAC, persistência e módulos de IA.
- Serviços externos: infraestrutura de inferência (Groq API) e bases de dados (Postgres/SQLite).

Diagrama (C4 Context)

```mermaid
%% Diagrama de Contexto C4 — Sistema Suvinil-IA
C4Context
    title Diagrama C4 — Sistema Suvinil-IA (Contexto)

    Person(user, "Usuário", "Interage para obter recomendações de tintas")

    System(suvinil_ia, "Suvinil-IA", "Motor de recomendação com IA + RBAC")

    Boundary(ext_ai, "Serviços Externos de IA") {
        System_Ext(groq_api, "Groq API", "Infra de inferência (Llama 3.1 8B)")
    }

    Boundary(data_layer, "Camada de Dados") {
        System_Ext(postgres, "PostgreSQL (Prod)", "Banco de dados de produção")
        System_Ext(sqlite, "SQLite (Dev)", "Banco de dados de desenvolvimento")
    }

    Rel(user, suvinil_ia, "Solicita recomendações")
    Rel(suvinil_ia, groq_api, "Chama inferência LLM")
    Rel(suvinil_ia, postgres, "Persiste/consulta dados (produção)")
    Rel(suvinil_ia, sqlite, "Persiste/consulta dados (desenvolvimento)")
```

## Containers

Visão de containers principais que compõem o backend:

```mermaid
%% C4 — Containers: Sistema Suvinil-IA
C4Container
    title Diagrama de Containers — Sistema Suvinil-IA

    Boundary(app, "Suvinil-IA (Backend)") {
        Container(fastapi_app, "API", "Python / FastAPI", "REST com RBAC, JWT e auditoria")
        ContainerDb(database, "DB Relacional", "PostgreSQL / SQLite + SQLAlchemy", "Migrations com Alembic; dados transacionais")
        Container(rag_service, "RAG Service", "LangChain / FAISS", "Busca semântica e indexação da base de conhecimento")
        Container(crewai_agents, "CrewAI Agents", "Python / CrewAI", "Orquestração de agentes para recomendação via RAG")
    }

    Boundary(ext, "Serviços Externos") {
        System_Ext(groq_api, "Groq API", "Llama 3.1 8B", "Plataforma de inferência LLM")
    }

    Rel(fastapi_app, database, "CRUD via SQLAlchemy")
    Rel(fastapi_app, crewai_agents, "Orquestra fluxos de recomendação")
    Rel(crewai_agents, rag_service, "Consulta/retorna chunks e embeddings")
    Rel(crewai_agents, groq_api, "Inferência LLM")
    Rel(rag_service, database, "Indexa e atualiza o corpus")
```


## Componentes

Principais componentes da aplicação FastAPI:

```mermaid
C4Component
    title Diagrama de Componentes - Aplicação FastAPI

    Component(core_api, "Core API", "FastAPI Routers/Controllers", "Endpoints REST com RBAC (users, roles, transactions, etc.)")
    Component(ia_api, "IA API", "FastAPI Routers/Controllers", "Endpoints para chat, documentos e recomendações")
    Component(auth_middleware, "Authorization Middleware", "Python", "Valida permissões RBAC em cada request")
    Component(models, "SQLAlchemy Models", "Python", "Modelos ORM com auditoria (User, Role, Paint, etc.)")
    Component(controllers, "Business Controllers", "Python", "Lógica de negócio (UserController, PaintController, etc.)")
    Component(schemas, "Pydantic Schemas", "Python", "Validação de request/response")

    Rel(core_api, auth_middleware, "Usa para validar acesso")
    Rel(ia_api, auth_middleware, "Usa para validar acesso")
    Rel(core_api, controllers, "Chama lógica de negócio")
    Rel(ia_api, controllers, "Chama lógica de negócio")
    Rel(controllers, models, "Persiste/recupera dados")
    Rel(core_api, schemas, "Valida dados de entrada/saída")
    Rel(ia_api, schemas, "Valida dados de entrada/saída")
```

## Legenda e convenções

- Nomes de tabelas: lowercase (ex.: `user`, `paint`).
- Colunas audit*: prefixadas com `audit_` e preenchidas automaticamente pelo `AbstractBaseModel`.
- Padrão de arquitetura: Router → Controller → Model → DB.
- Dependências comuns: `DbSession = Annotated[Session, Depends(get_session)]`, `CurrentUser = Annotated[User, Depends(get_current_user)]`.

## Como renderizar

Este arquivo está escrito para ser compatível com ferramentas que entendem sintaxe C4/PlantUML embutida em Markdown. Para gerar imagens/diagramas, você pode usar:

- PlantUML + C4 plugin (com suporte a blocos `C4Context`, `C4Container`, `C4Component`).
- Extensões VS Code que renderizam PlantUML/Markdown com diagramas.

Exemplo rápido com PlantUML:

1. Salve este bloco (apenas a seção do diagrama) em um arquivo `.puml`.
2. Execute uma ferramenta que converta PlantUML para PNG/SVG (ex.: extensão PlantUML do VS Code ou plantuml.jar).

## Notas finais

 - Este documento é de alto nível; detalhes das implementações (arquivo/rotas/nomes) ficam no código-fonte em `apps/core/` e `apps/ia/`.
 - Mantenha os diagramas sincronizados com alterações arquiteturais importantes.
